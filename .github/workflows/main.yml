name: RDP Setup and Software Installation

on:
  workflow_dispatch:

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:

      - name: Checkout Repository
        uses: actions/checkout@v2

      #######################################################################
      # ENABLE RDP + OPEN FIREWALL + DISABLE NLA
      #######################################################################
      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force

          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389

          Restart-Service -Name TermService -Force

      #######################################################################
      # CREATE WORKING ADMIN USER FOR RDP
      #######################################################################
      - name: Create RDP User
        run: |
          $username = "rdpadmin"
          $password = "Zain.rty123"
          $secure = ConvertTo-SecureString $password -AsPlainText -Force

          # Create user if not exists
          if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $username -Password $secure -AccountNeverExpires
          } else {
            Set-LocalUser -Name $username -Password $secure
          }

          # Add to admin groups
          Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue

          echo "RDP_USER=$username" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

      #######################################################################
      # INSTALL TAILSCALE
      #######################################################################
      - name: Install Tailscale
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $out = "$env:TEMP\tailscale.msi"

          Invoke-WebRequest -Uri $url -OutFile $out
          Start-Process msiexec.exe -ArgumentList "/i `"$out`" /quiet /norestart" -Wait
          Remove-Item $out

      - name: Establish Tailscale Connection
        run: |
          $authKey = "${{ secrets.TAILSCALE_AUTH_KEY }}"

          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$authKey --hostname=runner-$env:GITHUB_RUN_ID

          $tsIP = $null
          for ($i=0; $i -lt 10 -and -not $tsIP; $i++){
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            Start-Sleep 5
          }

          if (-not $tsIP) { throw "Tailscale IP not assigned." }

          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      #######################################################################
      # VERIFY RDP
      #######################################################################
      - name: Verify RDP Accessibility
        run: |
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          $test = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
          if (-not $test.TcpTestSucceeded) { throw "RDP port failed." }
          Write-Host "RDP port is open."

      #######################################################################
      # DOWNLOAD, EXTRACT AND COPY SOFTWARES TO DESKTOP
      #######################################################################
      - name: Download and Extract SOFTWARES
        run: |
          $downloadUrl = "https://github.com/Zaiinalii/RDP/releases/download/v1/sOFTWARES.rar"
          $downloadPath = "$env:TEMP\sOFTWARES.rar"
          $extractPath = "$env:TEMP\sOFTWARES_extracted"
          $desktopPath = "C:\Users\rdpadmin\Desktop"

          Invoke-WebRequest -Uri $downloadUrl -OutFile $downloadPath

          if (-not (Test-Path "C:\Program Files\7-Zip\7z.exe")) {
            Invoke-WebRequest "https://www.7-zip.org/a/7z1900-x64.exe" -OutFile "$env:TEMP\7z.exe"
            Start-Process "$env:TEMP\7z.exe" -ArgumentList "/S" -Wait
          }

          $sevenZip = "C:\Program Files\7-Zip\7z.exe"

          if (Test-Path $extractPath) { Remove-Item $extractPath -Recurse -Force }
          New-Item -ItemType Directory -Path $extractPath | Out-Null

          & $sevenZip x $downloadPath "-o$extractPath" -y

          Copy-Item "$extractPath\*" $desktopPath -Recurse -Force

          Remove-Item $downloadPath -Force
          Remove-Item $extractPath -Recurse -Force

      #######################################################################
      # INSTALL PYTHON 3.13.3
      #######################################################################
      - name: Install Python 3.13.3
        run: |
          $pythonUrl = "https://www.python.org/ftp/python/3.13.3/python-3.13.3-amd64.exe"
          $installer = "$env:TEMP\python3133.exe"

          Invoke-WebRequest -Uri $pythonUrl -OutFile $installer

          Start-Process -FilePath $installer -ArgumentList `
            "/quiet InstallAllUsers=1 PrependPath=1 Include_pip=1 Include_launcher=1" `
            -Wait

          Remove-Item $installer -Force

          python --version

      #######################################################################
      # INSTALL VISUAL STUDIO CODE (SYSTEM-WIDE)
      #######################################################################
      - name: Install Visual Studio Code
        run: |
          $url = "https://update.code.visualstudio.com/latest/win32-x64-system/stable"
          $installer = "$env:TEMP\vscode.exe"
          Invoke-WebRequest -Uri $url -OutFile $installer

          Start-Process $installer -ArgumentList "/verysilent /suppressmsgboxes /norestart" -Wait
          Remove-Item $installer -Force

      #######################################################################
      # CREATE SHORTCUTS
      #######################################################################
      - name: Create Desktop Shortcuts
        run: |
          $desktop = "C:\Users\rdpadmin\Desktop"
          $WshShell = New-Object -ComObject WScript.Shell

          # Python Shortcut
          $py = $WshShell.CreateShortcut("$desktop\Python 3.13.3.lnk")
          $py.TargetPath = "C:\Program Files\Python313\python.exe"
          $py.Save()

          # VS Code Shortcut
          $vs = $WshShell.CreateShortcut("$desktop\VS Code.lnk")
          $vs.TargetPath = "C:\Program Files\Microsoft VS Code\Code.exe"
          $vs.Save()

      #######################################################################
      # KEEP RUNNER ALIVE
      #######################################################################
      - name: Maintain RDP Connection
        run: |
          Write-Host "=== RDP ACCESS ==="
          Write-Host "IP: $env:TAILSCALE_IP"
          Write-Host "Username: $env:RDP_USER"
          Write-Host "Password: $env:RDP_PASSWORD"
          Write-Host "=================="
          while ($true) {
            Write-Host "[KEEP-ALIVE] $(Get-Date)"
            Start-Sleep 300
          }
